---
- hosts: kafka_servers  # Group containing your Kafka instance
  become: true
  tasks:
    - name: Install Java
      apt:
        name: openjdk-11-jdk-headless  # Or your preferred Java version
        state: present
        update_cache: yes

    - name: Create Kafka user
      user:
        name: kafka
        createhome: true
        shell: /bin/bash

    - name: Download Kafka
      get_url:
        url: "https://dlcdn.apache.org/kafka/{{ kafka_version }}/kafka_{{ kafka_version }}-{{ scala_version }}.tgz"
        dest: /tmp

    - name: Extract Kafka
      unarchive:
        src: /tmp/kafka_{{ kafka_version }}-{{ scala_version }}.tgz
        dest: /opt
        remote_src: yes

    - name: Create Kafka directory
      file:
        path: /opt/kafka
        state: directory
        mode: 0755

    - name: Move Kafka installation
      command: mv /opt/kafka_{{ kafka_version }}-{{ scala_version }} /opt/kafka

    - name: Create systemd service file for ZooKeeper
      template:
        src: zookeeper.service.j2
        dest: /etc/systemd/system/zookeeper.service

    - name: Create systemd service file for Kafka
      template:
        src: kafka.service.j2
        dest: /etc/systemd/system/kafka.service

    - name: Start and enable ZooKeeper
      systemd:
        name: zookeeper
        state: started
        enabled: yes

    - name: Start and enable Kafka
      systemd:
        name: kafka
        state: started
        enabled: yes

  vars:
    kafka_version: "3.4.0"  # Replace with your desired Kafka version
    scala_version: "2.13"   # Replace with the corresponding Scala version
